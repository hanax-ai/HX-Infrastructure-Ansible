name: hygiene
on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      infra: ${{ steps.filter.outputs.infra }}
      docs: ${{ steps.filter.outputs.docs }}
      wfs:  ${{ steps.filter.outputs.workflows }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infrastructure/**'
              - '.ansible-lint'
              - '.yamllint'
            docs:
              - 'docs/**'
              - '**/*.md'
            workflows:
              - '.github/workflows/**'

  hygiene:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.infra == 'true' ||
      needs.detect-changes.outputs.docs  == 'true' ||
      needs.detect-changes.outputs.workflows == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Install pinned CI deps
        run: |
          python -m pip install --upgrade pip
          pip install -r tools/ci/requirements-ci.txt
          npm i -g markdownlint-cli2

      - name: Docs lint (markdown)
        run: markdownlint-cli2 "**/*.md" "#node_modules"

      - name: YAML lint (only YAML, exclude docs/)
        run: |
          find . -type f \( -name "*.yml" -o -name "*.yaml" \) -not -path "./docs/*" -print0 \
          | xargs -0 -r yamllint -d "{extends: default, rules: {line-length: disable}}"

      - name: Ansible lint (infra changes only)
        if: needs.detect-changes.outputs.infra == 'true'
        run: ansible-lint infrastructure/ansible

      - name: Integration gate (infra changes only)
        if: needs.detect-changes.outputs.infra == 'true'
        run: scripts/ci/integration-gate.sh
