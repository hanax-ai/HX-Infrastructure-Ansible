
# {{ ansible_managed }}
# HX Domain Join Health Check Report
# Generated: {{ ansible_date_time.iso8601 }}

## System Information
Hostname: {{ ansible_hostname }}
FQDN: {{ ansible_fqdn }}
Operating System: {{ ansible_distribution }} {{ ansible_distribution_version }}
Architecture: {{ ansible_architecture }}

## Domain Configuration
Target Domain: {{ hx_ad_domain }}
Kerberos Realm: {{ hx_ad_realm }}
Computer Name: {{ hx_ad_computer_name }}
Computer FQDN: {{ hx_ad_computer_fqdn }}

## Domain Membership Status
{% if hx_domain_membership_check is defined %}
Domain Membership: {{ (hx_domain_membership_check.rc == 0 and hx_ad_domain in hx_domain_membership_check.stdout) | ternary('✓ JOINED', '✗ NOT JOINED') }}
{% if hx_domain_membership_check.rc == 0 %}
Realm Output: {{ hx_domain_membership_check.stdout }}
{% else %}
Error: {{ hx_domain_membership_check.stderr | default('Unknown error') }}
{% endif %}
{% endif %}

## Service Status
{% if hx_sssd_service_status is defined %}
SSSD Service: {{ hx_sssd_service_status.status.ActiveState == 'active' | ternary('✓ RUNNING', '✗ STOPPED') }}
Service State: {{ hx_sssd_service_status.status.ActiveState }}
Service Enabled: {{ hx_sssd_service_status.status.UnitFileState == 'enabled' | ternary('Yes', 'No') }}
{% endif %}

## Network Connectivity
{% if hx_dns_resolution_test is defined %}
DNS Resolution: {{ hx_dns_resolution_test.rc == 0 | ternary('✓ WORKING', '✗ FAILED') }}
{% if hx_dns_resolution_test.rc != 0 %}
DNS Error: {{ hx_dns_resolution_test.stderr | default('Resolution failed') }}
{% endif %}
{% endif %}

{% if hx_dc_connectivity_test is defined %}
Domain Controller Connectivity: {{ hx_dc_connectivity_test.rc == 0 | ternary('✓ CONNECTED', '✗ FAILED') }}
Connectivity Details: {{ hx_dc_connectivity_test.stdout }}
{% endif %}

## Authentication Tests
{% if hx_user_lookup_test is defined %}
User Lookup: {{ hx_user_lookup_test.rc == 0 | ternary('✓ WORKING', '✗ FAILED') }}
User Lookup Details: {{ hx_user_lookup_test.stdout }}
{% endif %}

{% if hx_group_lookup_test is defined %}
Group Lookup: {{ hx_group_lookup_test.rc == 0 | ternary('✓ WORKING', '✗ FAILED') }}
Group Lookup Details: {{ hx_group_lookup_test.stdout }}
{% endif %}

{% if hx_kerberos_ticket_test is defined %}
Kerberos Authentication: {{ hx_kerberos_ticket_test.rc == 0 | ternary('✓ WORKING', '✗ FAILED') }}
{% if hx_kerberos_ticket_test.rc != 0 %}
Kerberos Error: Authentication failed
{% endif %}
{% endif %}

## SSSD Cache Status
{% if hx_sssd_cache_check is defined %}
SSSD Cache: {{ hx_sssd_cache_check.rc == 0 | ternary('✓ POPULATED', '✗ EMPTY') }}
Cache Details: {{ hx_sssd_cache_check.stdout }}
{% endif %}

## Home Directory Configuration
{% if hx_home_dir_test is defined %}
Home Directory Setup: {{ hx_home_dir_test.rc == 0 | ternary('✓ CONFIGURED', '✗ ISSUES') }}
Home Directory Details: {{ hx_home_dir_test.stdout }}
{% endif %}

## Configuration Files Status
SSSD Config: {{ hx_sssd_conf_path }}
Kerberos Config: {{ hx_krb5_conf_path }}
Realmd Config: {{ hx_realmd_conf_path }}
NSSwitch Config: {{ hx_nsswitch_conf_path }}

## Health Score Summary
{% if hx_health_checks_passed is defined and hx_health_checks_total is defined %}
Total Checks: {{ hx_health_checks_total }}
Passed: {{ hx_health_checks_passed }}
Failed: {{ hx_health_checks_total | int - hx_health_checks_passed | int }}
Success Rate: {{ ((hx_health_checks_passed | int / hx_health_checks_total | int) * 100) | round(1) }}%

Overall Status: {{ (hx_health_checks_passed == hx_health_checks_total) | ternary('✓ HEALTHY', '✗ ISSUES DETECTED') }}
{% endif %}

## Troubleshooting Information
{% if hx_health_checks_passed | int < hx_health_checks_total | int %}
Common Issues and Solutions:

1. Domain Membership Issues:
   - Check network connectivity to domain controllers
   - Verify DNS resolution for the domain
   - Ensure correct admin credentials

2. SSSD Service Issues:
   - Check SSSD configuration syntax
   - Review SSSD logs: journalctl -u sssd
   - Clear SSSD cache if needed

3. Authentication Issues:
   - Verify Kerberos configuration
   - Check time synchronization with domain controllers
   - Test with kinit command manually

4. User/Group Lookup Issues:
   - Ensure SSSD is running and configured
   - Check NSSwitch configuration
   - Verify domain trust relationships
{% endif %}

## Log Locations
- SSSD Logs: /var/log/sssd/
- Kerberos Logs: /var/log/krb5lib.log
- Domain Join Logs: {{ hx_domain_log_dir }}/
- System Logs: journalctl -u sssd -u realmd

---
Report generated by HX Domain Join Role v{{ hx_domain_join_version }}
Ansible managed: {{ ansible_managed }}
