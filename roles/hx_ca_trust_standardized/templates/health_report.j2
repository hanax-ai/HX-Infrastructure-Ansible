
# {{ ansible_managed }}
# HX CA Trust Health Check Report
# Generated: {{ ansible_date_time.iso8601 }}

## System Information
Hostname: {{ ansible_hostname }}
Operating System: {{ ansible_distribution }} {{ ansible_distribution_version }}
Architecture: {{ ansible_architecture }}

## Certificate Status
Certificate File: {{ hx_ca_cert_full_path }}
File Exists: {{ hx_ca_cert_stat.stat.exists | ternary('✓ Yes', '✗ No') }}
File Readable: {{ hx_ca_cert_stat.stat.readable | default(false) | ternary('✓ Yes', '✗ No') }}
File Size: {{ hx_ca_cert_stat.stat.size | default(0) }} bytes
Last Modified: {{ hx_ca_cert_stat.stat.mtime | default(0) | int | strftime('%Y-%m-%d %H:%M:%S') }}

## Certificate Parsing
{% if hx_ca_parse_test is defined %}
Parse Test: {{ hx_ca_parse_test.rc == 0 | ternary('✓ PASSED', '✗ FAILED') }}
{% if hx_ca_parse_test.rc == 0 %}
Subject: {{ hx_ca_parse_test.stdout }}
{% else %}
Error: {{ hx_ca_parse_test.stderr }}
{% endif %}
{% endif %}

## System Trust Store Integration
{% if hx_ca_trust_store_check is defined %}
Trust Store Status: {{ hx_ca_trust_store_check.rc == 0 | ternary('✓ INTEGRATED', '✗ NOT FOUND') }}
{% if hx_ca_trust_store_check.rc != 0 %}
Error: {{ hx_ca_trust_store_check.stderr }}
{% endif %}
{% endif %}

## SSL Connection Tests
{% if hx_ca_ssl_test is defined %}
CA Host SSL Test: {{ hx_ca_ssl_test.rc == 0 | ternary('✓ CONNECTED', '✗ FAILED') }}
Target: {{ hx_ca_host }}:443
{% if hx_ca_ssl_test.rc != 0 %}
Error: {{ hx_ca_ssl_test.stderr | default('Connection failed') }}
{% endif %}
{% endif %}

## Target Validation Results
{% if hx_ca_target_validation is defined and hx_ca_target_validation.results %}
{% for result in hx_ca_target_validation.results %}
Target: {{ result.item.address }}:{{ result.item.port | default(443) }}
Status: {{ result.rc == 0 | ternary('✓ VALID', '✗ FAILED') }}
{% if result.rc != 0 %}
Error: {{ result.stderr | default('Validation failed') }}
{% endif %}

{% endfor %}
{% else %}
Target Validation: No targets configured
{% endif %}

## Health Endpoint Checks
{% if hx_ca_health_endpoint_check is defined and hx_ca_health_endpoint_check.results %}
{% for result in hx_ca_health_endpoint_check.results %}
Endpoint: {{ result.item.health_url }}
Status: {{ result.status | default('Unknown') }}
Response Time: {{ result.elapsed | default(0) }}s
Result: {{ result.status == 200 | ternary('✓ HEALTHY', '✗ UNHEALTHY') }}

{% endfor %}
{% else %}
Health Endpoints: None configured
{% endif %}

## Summary
{% set total_checks = 0 %}
{% set passed_checks = 0 %}
{% if hx_ca_cert_stat.stat.exists %}
  {% set total_checks = total_checks + 1 %}
  {% set passed_checks = passed_checks + 1 %}
{% endif %}
{% if hx_ca_parse_test is defined %}
  {% set total_checks = total_checks + 1 %}
  {% if hx_ca_parse_test.rc == 0 %}
    {% set passed_checks = passed_checks + 1 %}
  {% endif %}
{% endif %}
{% if hx_ca_trust_store_check is defined %}
  {% set total_checks = total_checks + 1 %}
  {% if hx_ca_trust_store_check.rc == 0 %}
    {% set passed_checks = passed_checks + 1 %}
  {% endif %}
{% endif %}

Total Checks: {{ total_checks }}
Passed: {{ passed_checks }}
Failed: {{ total_checks - passed_checks }}
Success Rate: {{ ((passed_checks / total_checks) * 100) | round(1) if total_checks > 0 else 0 }}%

Overall Status: {{ (passed_checks == total_checks) | ternary('✓ HEALTHY', '✗ ISSUES DETECTED') }}

---
Report generated by HX CA Trust Role v{{ hx_ca_trust_version }}
Ansible managed: {{ ansible_managed }}
