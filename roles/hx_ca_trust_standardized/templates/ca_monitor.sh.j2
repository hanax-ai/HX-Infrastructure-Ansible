
#!/bin/bash
# {{ ansible_managed }}
# HX CA Certificate Monitoring Script

set -euo pipefail

# Configuration
CERT_PATH="{{ hx_ca_cert_full_path }}"
LOG_DIR="{{ hx_ca_log_dir }}"
ALERT_DAYS=30

# Functions
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "${LOG_DIR}/monitor.log"
}

check_certificate_expiry() {
    if [ ! -f "$CERT_PATH" ]; then
        log_message "ERROR: Certificate file not found: $CERT_PATH"
        return 1
    fi
    
    expiry_date=$(openssl x509 -in "$CERT_PATH" -enddate -noout | cut -d= -f2)
    expiry_epoch=$(date -d "$expiry_date" +%s)
    current_epoch=$(date +%s)
    days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))
    
    if [ $days_until_expiry -lt $ALERT_DAYS ]; then
        log_message "WARNING: Certificate expires in $days_until_expiry days (expires: $expiry_date)"
        return 2
    else
        log_message "INFO: Certificate valid for $days_until_expiry days"
        return 0
    fi
}

check_certificate_validity() {
    if ! openssl x509 -in "$CERT_PATH" -noout -checkend 0 >/dev/null 2>&1; then
        log_message "ERROR: Certificate is expired or invalid"
        return 1
    fi
    
    log_message "INFO: Certificate is valid"
    return 0
}

check_trust_store() {
    cert_hash=$(openssl x509 -in "$CERT_PATH" -hash -noout)
    if [ -L "/etc/ssl/certs/${cert_hash}.0" ]; then
        log_message "INFO: Certificate is in system trust store"
        return 0
    else
        log_message "WARNING: Certificate not found in system trust store"
        return 1
    fi
}

# Main execution
main() {
    log_message "Starting certificate monitoring check"
    
    local exit_code=0
    
    check_certificate_validity || exit_code=$?
    check_certificate_expiry || exit_code=$?
    check_trust_store || exit_code=$?
    
    log_message "Certificate monitoring check completed (exit code: $exit_code)"
    
    return $exit_code
}

# Execute main function
main "$@"
