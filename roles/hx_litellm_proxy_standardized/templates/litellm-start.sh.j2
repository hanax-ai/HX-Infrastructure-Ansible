
#!/bin/bash
# LiteLLM Proxy startup script
# Generated by Ansible - HX LiteLLM Proxy Standardized Role
# {{ ansible_managed }}

set -euo pipefail

# Configuration
VENV_PATH="{{ hx_litellm_venv_path }}"
CONFIG_FILE="{{ hx_litellm_config_dir }}/config.yaml"
LOG_DIR="{{ hx_litellm_log_dir }}"
HOST="{{ hx_litellm_host }}"
PORT="{{ hx_litellm_port }}"
WORKERS="{{ hx_litellm_workers }}"

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Activate virtual environment
source "$VENV_PATH/bin/activate"

# Set environment variables
export LITELLM_LOG="{{ hx_litellm_log_level }}"
export LITELLM_DROP_PARAMS="true"
export LITELLM_SET_VERBOSE="{{ 'true' if hx_litellm_log_level == 'DEBUG' else 'false' }}"
{% for key, value in hx_litellm_env_vars.items() %}
export {{ key }}="{{ value }}"
{% endfor %}

# Health check function
health_check() {
    curl -sf "http://${HOST}:${PORT}{{ hx_litellm_health_check_path }}" > /dev/null
}

# Start LiteLLM proxy
echo "Starting LiteLLM proxy..."
echo "Config file: $CONFIG_FILE"
echo "Host: $HOST"
echo "Port: $PORT"
echo "Workers: $WORKERS"

exec litellm \
    --config "$CONFIG_FILE" \
    --host "$HOST" \
    --port "$PORT" \
    --num_workers "$WORKERS" \
{% if hx_litellm_ssl_enabled %}
    --ssl_keyfile "{{ hx_litellm_ssl_key_file }}" \
    --ssl_certfile "{{ hx_litellm_ssl_cert_file }}" \
{% endif %}
    --access-log \
    --use-colors \
    2>&1 | tee -a "$LOG_DIR/litellm.log"
