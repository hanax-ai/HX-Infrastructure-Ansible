#!/bin/bash

# LiteLLM Proxy Startup Script
# Generated by Ansible

set -e

# Configuration
CONFIG_FILE="{{ hx_litellm_config_dir }}/config.yaml"
HOST="{{ hx_litellm_host }}"
PORT="{{ hx_litellm_port }}"
WORKERS="{{ hx_litellm_workers }}"
LOG_DIR="{{ hx_litellm_log_dir }}"

# Create log directory
mkdir -p "$LOG_DIR"
umask 027
touch "$LOG_DIR/litellm.log"
exec >> "$LOG_DIR/litellm.log" 2>&1

# Set environment variables
export LITELLM_LOG="{{ hx_litellm_log_level }}"
{% for key, value in hx_litellm_env_vars.items() %}
export {{ key }}="{{ value }}"
{% endfor %}

echo "Starting LiteLLM proxy..."
echo "Config file: $CONFIG_FILE"
echo "Host: $HOST"
echo "Port: $PORT"
echo "Workers: $WORKERS"

exec litellm \
    --config "$CONFIG_FILE" \
    --host "$HOST" \
    --port "$PORT" \
    --num_workers "$WORKERS" \
{% if hx_litellm_ssl_enabled %}
    --ssl_keyfile "{{ hx_litellm_ssl_key_file }}" \
    --ssl_certfile "{{ hx_litellm_ssl_cert_file }}" \
{% endif %}
    --access-log \
    --use-colors{% if hx_litellm_drop_params | default(false) %} \
    --drop_params{% endif %}
