
global:
  scrape_interval: {{ prometheus_scrape_interval | default('15s') }}
  evaluation_interval: {{ prometheus_evaluation_interval | default('15s') }}
  external_labels:
    cluster: '{{ prometheus_cluster_name | default("default") }}'
    environment: '{{ environment | default("production") }}'

rule_files:
  - "/etc/prometheus/rules/*.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
{% for alertmanager in prometheus_alertmanagers | default([]) %}
          - {{ alertmanager }}
{% endfor %}

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:{{ prometheus_port | default(9090) }}']
    scrape_interval: 5s
    metrics_path: /metrics

  - job_name: 'node-exporter'
    static_configs:
      - targets:
{% for host in groups['all'] | default([]) %}
        - {{ hostvars[host]['ansible_default_ipv4']['address'] }}:9100
{% endfor %}
    scrape_interval: 15s
    metrics_path: /metrics

{% if prometheus_additional_jobs is defined %}
{% for job in prometheus_additional_jobs %}
  - job_name: '{{ job.name }}'
    static_configs:
      - targets:
{% for target in job.targets %}
        - {{ target }}
{% endfor %}
{% if job.scrape_interval is defined %}
    scrape_interval: {{ job.scrape_interval }}
{% endif %}
{% if job.metrics_path is defined %}
    metrics_path: {{ job.metrics_path }}
{% endif %}
{% if job.params is defined %}
    params:
{% for key, value in job.params.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}

  - job_name: 'ansible-automation-platform'
    static_configs:
      - targets:
{% for aap_host in prometheus_aap_hosts | default([]) %}
        - {{ aap_host }}
{% endfor %}
    scrape_interval: 30s
    metrics_path: /api/v2/metrics/
    scheme: https
    tls_config:
      insecure_skip_verify: {{ prometheus_aap_skip_tls_verify | default(false) }}
    bearer_token: {{ prometheus_aap_token | default('') }}

  - job_name: 'blackbox'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
{% for target in prometheus_blackbox_targets | default([]) %}
        - {{ target }}
{% endfor %}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: {{ prometheus_blackbox_exporter | default('localhost:9115') }}

