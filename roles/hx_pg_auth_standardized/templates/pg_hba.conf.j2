
# PostgreSQL Client Authentication Configuration File
# Generated by Ansible - HX Infrastructure
# ===================================================================
#
# HBA stands for host-based authentication. Refer to the
# "Client Authentication" section in the PostgreSQL documentation
# for a complete description of this file.

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             postgres                                peer

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            {{ hx_pg_local_auth_method | default('md5') }}

{% if hx_pg_allow_local_connections | default(true) %}
# Allow local connections for all users
host    all             all             127.0.0.1/32            {{ hx_pg_local_auth_method | default('md5') }}
host    all             all             ::1/128                 {{ hx_pg_local_auth_method | default('md5') }}
{% endif %}

{% for connection in hx_pg_hba_entries | default([]) %}
# {{ connection.comment | default('Custom connection') }}
{{ connection.type | default('host') }}    {{ connection.database | default('all') }}             {{ connection.user | default('all') }}             {{ connection.address | default('127.0.0.1/32') }}                 {{ connection.method | default('md5') }}{% if connection.options is defined %} {{ connection.options }}{% endif %}

{% endfor %}

{% if hx_pg_replication_connections | default([]) %}
# Replication connections
{% for repl in hx_pg_replication_connections %}
# {{ repl.comment | default('Replication connection') }}
{{ repl.type | default('host') }}    replication     {{ repl.user }}             {{ repl.address }}                 {{ repl.method | default('md5') }}{% if repl.options is defined %} {{ repl.options }}{% endif %}

{% endfor %}
{% endif %}

{% if hx_pg_ssl_connections | default([]) %}
# SSL connections
{% for ssl in hx_pg_ssl_connections %}
# {{ ssl.comment | default('SSL connection') }}
hostssl {{ ssl.database | default('all') }}             {{ ssl.user | default('all') }}             {{ ssl.address }}                 {{ ssl.method | default('md5') }}{% if ssl.options is defined %} {{ ssl.options }}{% endif %}

{% endfor %}
{% endif %}

{% if hx_pg_no_ssl_connections | default([]) %}
# Non-SSL connections
{% for nossl in hx_pg_no_ssl_connections %}
# {{ nossl.comment | default('Non-SSL connection') }}
hostnossl {{ nossl.database | default('all') }}             {{ nossl.user | default('all') }}             {{ nossl.address }}                 {{ nossl.method | default('md5') }}{% if nossl.options is defined %} {{ nossl.options }}{% endif %}

{% endfor %}
{% endif %}

# Security: Reject all other connections
{% if hx_pg_reject_other_connections | default(true) %}
# Reject all other connections for security
host    all             all             0.0.0.0/0               reject
host    all             all             ::/0                    reject
{% endif %}
