
# PostgreSQL Configuration File
# Generated by Ansible - HX PostgreSQL Auth Standardized Role
# {{ ansible_managed }}

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection Settings
listen_addresses = '{{ hx_pg_listen_addresses }}'
port = {{ hx_pg_port }}
max_connections = {{ hx_pg_max_connections }}
superuser_reserved_connections = {{ hx_pg_superuser_reserved_connections }}

# SSL Configuration
{% if hx_pg_ssl_enabled %}
ssl = on
ssl_cert_file = '{{ hx_pg_ssl_cert_file }}'
ssl_key_file = '{{ hx_pg_ssl_key_file }}'
{% if hx_pg_ssl_ca_file %}
ssl_ca_file = '{{ hx_pg_ssl_ca_file }}'
{% endif %}
{% if hx_pg_ssl_crl_file %}
ssl_crl_file = '{{ hx_pg_ssl_crl_file }}'
{% endif %}
ssl_ciphers = '{{ hx_pg_ssl_ciphers }}'
ssl_prefer_server_ciphers = {{ hx_pg_ssl_prefer_server_ciphers | lower }}
{% else %}
ssl = off
{% endif %}

# Authentication
password_encryption = {{ hx_pg_password_encryption }}

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory
shared_buffers = 128MB
dynamic_shared_memory_type = posix

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

# Settings
wal_level = replica
max_wal_senders = 3
wal_keep_segments = 32

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Cost Constants
random_page_cost = 1.1
effective_cache_size = 4GB

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Where to Log
log_destination = 'stderr'
logging_collector = on
log_directory = '{{ hx_pg_log_dir }}'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_file_mode = 0600
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 10MB

# When to Log
log_min_messages = warning
log_min_error_statement = error
log_min_duration_statement = -1

# What to Log
debug_print_parse = off
debug_print_rewritten = off
debug_print_plan = off
debug_pretty_print = on
log_checkpoints = on
log_connections = {{ hx_pg_log_connections | lower }}
log_disconnections = {{ hx_pg_log_disconnections | lower }}
log_duration = off
log_error_verbosity = default
log_hostname = {{ hx_pg_log_hostname | lower }}
log_line_prefix = '{{ hx_pg_log_line_prefix }}'
log_lock_waits = off
log_statement = 'none'
log_temp_files = -1
log_timezone = 'UTC'

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------

# Query/Index Statistics Collector
track_activities = {{ hx_pg_track_activities | lower }}
track_counts = {{ hx_pg_track_counts | lower }}
track_io_timing = off
track_functions = {{ hx_pg_track_functions }}
track_activity_query_size = 1024
stats_temp_directory = 'pg_stat_tmp'

#------------------------------------------------------------------------------
# AUTOVACUUM PARAMETERS
#------------------------------------------------------------------------------

autovacuum = on
log_autovacuum_min_duration = -1
autovacuum_max_workers = 3
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.2
autovacuum_analyze_scale_factor = 0.1
autovacuum_freeze_max_age = 200000000
autovacuum_multixact_freeze_max_age = 400000000
autovacuum_vacuum_cost_delay = 20ms
autovacuum_vacuum_cost_limit = -1

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement Behavior
search_path = '"$user", public'
default_tablespace = ''
temp_tablespaces = ''
check_function_bodies = on
default_transaction_isolation = 'read committed'
default_transaction_read_only = off
default_transaction_deferrable = off
session_replication_role = 'origin'
statement_timeout = 0
lock_timeout = 0
idle_in_transaction_session_timeout = 0
vacuum_freeze_min_age = 50000000
vacuum_freeze_table_age = 150000000
vacuum_multixact_freeze_min_age = 5000000
vacuum_multixact_freeze_table_age = 150000000
bytea_output = 'hex'
xmlbinary = 'base64'
xmloption = 'content'
gin_fuzzy_search_limit = 0

# Locale and Formatting
datestyle = 'iso, mdy'
intervalstyle = 'postgres'
timezone = 'UTC'
timezone_abbreviations = 'Default'
extra_float_digits = 0
client_encoding = sql_ascii

# Shared Library Preloading
shared_preload_libraries = '{{ hx_pg_shared_preload_libraries }}'

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

deadlock_timeout = 1s
max_locks_per_transaction = 64
max_pred_locks_per_transaction = 64

#------------------------------------------------------------------------------
# VERSION/PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

# Previous PostgreSQL Versions
array_nulls = on
backslash_quote = safe_encoding
default_with_oids = off
escape_string_warning = on
lo_compat_privileges = off
operator_precedence_warning = off
quote_all_identifiers = off
sql_inheritance = on
standard_conforming_strings = on
synchronize_seqscans = on

# Other Platforms and Clients
transform_null_equals = off
