
# PostgreSQL Configuration Template
# Generated by Ansible - HX Infrastructure

#------------------------------------------------------------------------------
# FILE LOCATIONS
#------------------------------------------------------------------------------
data_directory = '{{ hx_pg_data_directory | default("/var/lib/postgresql/data") }}'
hba_file = '{{ hx_pg_data_directory | default("/var/lib/postgresql/data") }}/pg_hba.conf'
ident_file = '{{ hx_pg_data_directory | default("/var/lib/postgresql/data") }}/pg_ident.conf'

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------
listen_addresses = '{{ hx_pg_listen_addresses | default("localhost") }}'
port = {{ hx_pg_port | default(5432) }}
max_connections = {{ hx_pg_max_connections | default(100) }}
superuser_reserved_connections = {{ hx_pg_superuser_reserved_connections | default(3) }}

# SSL Configuration
ssl = {{ 'on' if hx_pg_enable_ssl | default(true) else 'off' }}
ssl_cert_file = '{{ hx_pg_ssl_cert_file | default("server.crt") }}'
ssl_key_file = '{{ hx_pg_ssl_key_file | default("server.key") }}'
ssl_ca_file = '{{ hx_pg_ssl_ca_file | default("") }}'

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------
shared_buffers = {{ hx_pg_shared_buffers | default("128MB") }}
huge_pages = {{ hx_pg_huge_pages | default("try") }}
temp_buffers = {{ hx_pg_temp_buffers | default("8MB") }}
max_prepared_transactions = {{ hx_pg_max_prepared_transactions | default(0) }}
work_mem = {{ hx_pg_work_mem | default("4MB") }}
maintenance_work_mem = {{ hx_pg_maintenance_work_mem | default("64MB") }}

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------
wal_level = {{ hx_pg_wal_level | default("replica") }}
fsync = {{ 'on' if hx_pg_fsync | default(true) else 'off' }}
synchronous_commit = {{ hx_pg_synchronous_commit | default("on") }}
wal_sync_method = {{ hx_pg_wal_sync_method | default("fsync") }}
full_page_writes = {{ 'on' if hx_pg_full_page_writes | default(true) else 'off' }}
wal_buffers = {{ hx_pg_wal_buffers | default("16MB") }}
wal_writer_delay = {{ hx_pg_wal_writer_delay | default("200ms") }}
checkpoint_completion_target = {{ hx_pg_checkpoint_completion_target | default(0.5) }}
max_wal_size = {{ hx_pg_max_wal_size | default("1GB") }}
min_wal_size = {{ hx_pg_min_wal_size | default("80MB") }}

# Archive settings
{% if hx_pg_enable_wal_archiving | default(false) %}
archive_mode = on
archive_command = '{{ hx_pg_archive_command | default("test ! -f /var/lib/postgresql/archive/%f && cp %p /var/lib/postgresql/archive/%f") }}'
{% else %}
archive_mode = off
{% endif %}

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------
max_wal_senders = {{ hx_pg_max_wal_senders | default(10) }}
max_replication_slots = {{ hx_pg_max_replication_slots | default(10) }}
wal_keep_segments = {{ hx_pg_wal_keep_segments | default(32) }}
hot_standby = {{ 'on' if hx_pg_hot_standby | default(true) else 'off' }}

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------
enable_bitmapscan = {{ 'on' if hx_pg_enable_bitmapscan | default(true) else 'off' }}
enable_hashagg = {{ 'on' if hx_pg_enable_hashagg | default(true) else 'off' }}
enable_hashjoin = {{ 'on' if hx_pg_enable_hashjoin | default(true) else 'off' }}
enable_indexscan = {{ 'on' if hx_pg_enable_indexscan | default(true) else 'off' }}
enable_indexonlyscan = {{ 'on' if hx_pg_enable_indexonlyscan | default(true) else 'off' }}
enable_material = {{ 'on' if hx_pg_enable_material | default(true) else 'off' }}
enable_mergejoin = {{ 'on' if hx_pg_enable_mergejoin | default(true) else 'off' }}
enable_nestloop = {{ 'on' if hx_pg_enable_nestloop | default(true) else 'off' }}
enable_seqscan = {{ 'on' if hx_pg_enable_seqscan | default(true) else 'off' }}
enable_sort = {{ 'on' if hx_pg_enable_sort | default(true) else 'off' }}
enable_tidscan = {{ 'on' if hx_pg_enable_tidscan | default(true) else 'off' }}

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------
log_destination = '{{ hx_pg_log_destination | default("stderr") }}'
logging_collector = {{ 'on' if hx_pg_logging_collector | default(true) else 'off' }}
log_directory = '{{ hx_pg_log_directory | default("log") }}'
log_filename = '{{ hx_pg_log_filename | default("postgresql-%Y-%m-%d_%H%M%S.log") }}'
log_file_mode = {{ hx_pg_log_file_mode | default("0600") }}
log_truncate_on_rotation = {{ 'on' if hx_pg_log_truncate_on_rotation | default(false) else 'off' }}
log_rotation_age = {{ hx_pg_log_rotation_age | default("1d") }}
log_rotation_size = {{ hx_pg_log_rotation_size | default("10MB") }}

# What to log
log_min_messages = {{ hx_pg_log_min_messages | default("warning") }}
log_min_error_statement = {{ hx_pg_log_min_error_statement | default("error") }}
log_min_duration_statement = {{ hx_pg_log_min_duration_statement | default(-1) }}
log_checkpoints = {{ 'on' if hx_pg_log_checkpoints | default(false) else 'off' }}
log_connections = {{ 'on' if hx_pg_log_connections | default(false) else 'off' }}
log_disconnections = {{ 'on' if hx_pg_log_disconnections | default(false) else 'off' }}
log_lock_waits = {{ 'on' if hx_pg_log_lock_waits | default(false) else 'off' }}
log_statement = '{{ hx_pg_log_statement | default("none") }}'
log_temp_files = {{ hx_pg_log_temp_files | default(-1) }}

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------
track_activities = {{ 'on' if hx_pg_track_activities | default(true) else 'off' }}
track_counts = {{ 'on' if hx_pg_track_counts | default(true) else 'off' }}
track_io_timing = {{ 'on' if hx_pg_track_io_timing | default(false) else 'off' }}
track_functions = {{ hx_pg_track_functions | default("none") }}
track_activity_query_size = {{ hx_pg_track_activity_query_size | default(1024) }}
stats_temp_directory = '{{ hx_pg_stats_temp_directory | default("pg_stat_tmp") }}'

#------------------------------------------------------------------------------
# AUTOVACUUM PARAMETERS
#------------------------------------------------------------------------------
autovacuum = {{ 'on' if hx_pg_autovacuum | default(true) else 'off' }}
log_autovacuum_min_duration = {{ hx_pg_log_autovacuum_min_duration | default(-1) }}
autovacuum_max_workers = {{ hx_pg_autovacuum_max_workers | default(3) }}
autovacuum_naptime = {{ hx_pg_autovacuum_naptime | default("1min") }}
autovacuum_vacuum_threshold = {{ hx_pg_autovacuum_vacuum_threshold | default(50) }}
autovacuum_analyze_threshold = {{ hx_pg_autovacuum_analyze_threshold | default(50) }}
autovacuum_vacuum_scale_factor = {{ hx_pg_autovacuum_vacuum_scale_factor | default(0.2) }}
autovacuum_analyze_scale_factor = {{ hx_pg_autovacuum_analyze_scale_factor | default(0.1) }}
autovacuum_freeze_max_age = {{ hx_pg_autovacuum_freeze_max_age | default(200000000) }}
autovacuum_multixact_freeze_max_age = {{ hx_pg_autovacuum_multixact_freeze_max_age | default(400000000) }}
autovacuum_vacuum_cost_delay = {{ hx_pg_autovacuum_vacuum_cost_delay | default("20ms") }}
autovacuum_vacuum_cost_limit = {{ hx_pg_autovacuum_vacuum_cost_limit | default(-1) }}

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------
search_path = '{{ hx_pg_search_path | default("\"$user\", public") }}'
default_tablespace = '{{ hx_pg_default_tablespace | default("") }}'
temp_tablespaces = '{{ hx_pg_temp_tablespaces | default("") }}'
check_function_bodies = {{ 'on' if hx_pg_check_function_bodies | default(true) else 'off' }}
default_transaction_isolation = '{{ hx_pg_default_transaction_isolation | default("read committed") }}'
default_transaction_read_only = {{ 'on' if hx_pg_default_transaction_read_only | default(false) else 'off' }}
default_transaction_deferrable = {{ 'on' if hx_pg_default_transaction_deferrable | default(false) else 'off' }}
session_replication_role = '{{ hx_pg_session_replication_role | default("origin") }}'
statement_timeout = {{ hx_pg_statement_timeout | default(0) }}
lock_timeout = {{ hx_pg_lock_timeout | default(0) }}
idle_in_transaction_session_timeout = {{ hx_pg_idle_in_transaction_session_timeout | default(0) }}
vacuum_freeze_min_age = {{ hx_pg_vacuum_freeze_min_age | default(50000000) }}
vacuum_freeze_table_age = {{ hx_pg_vacuum_freeze_table_age | default(150000000) }}
vacuum_multixact_freeze_min_age = {{ hx_pg_vacuum_multixact_freeze_min_age | default(5000000) }}
vacuum_multixact_freeze_table_age = {{ hx_pg_vacuum_multixact_freeze_table_age | default(150000000) }}
bytea_output = '{{ hx_pg_bytea_output | default("hex") }}'
xmlbinary = '{{ hx_pg_xmlbinary | default("base64") }}'
xmloption = '{{ hx_pg_xmloption | default("content") }}'
gin_fuzzy_search_limit = {{ hx_pg_gin_fuzzy_search_limit | default(0) }}

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------
deadlock_timeout = {{ hx_pg_deadlock_timeout | default("1s") }}
max_locks_per_transaction = {{ hx_pg_max_locks_per_transaction | default(64) }}
max_pred_locks_per_transaction = {{ hx_pg_max_pred_locks_per_transaction | default(64) }}
max_pred_locks_per_relation = {{ hx_pg_max_pred_locks_per_relation | default(-2) }}
max_pred_locks_per_page = {{ hx_pg_max_pred_locks_per_page | default(2) }}

#------------------------------------------------------------------------------
# VERSION/PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------
array_nulls = {{ 'on' if hx_pg_array_nulls | default(true) else 'off' }}
backslash_quote = {{ hx_pg_backslash_quote | default("safe_encoding") }}
default_with_oids = {{ 'on' if hx_pg_default_with_oids | default(false) else 'off' }}
escape_string_warning = {{ 'on' if hx_pg_escape_string_warning | default(true) else 'off' }}
lo_compat_privileges = {{ 'on' if hx_pg_lo_compat_privileges | default(false) else 'off' }}
operator_precedence_warning = {{ 'on' if hx_pg_operator_precedence_warning | default(false) else 'off' }}
quote_all_identifiers = {{ 'on' if hx_pg_quote_all_identifiers | default(false) else 'off' }}
sql_inheritance = {{ 'on' if hx_pg_sql_inheritance | default(true) else 'off' }}
standard_conforming_strings = {{ 'on' if hx_pg_standard_conforming_strings | default(true) else 'off' }}
synchronize_seqscans = {{ 'on' if hx_pg_synchronize_seqscans | default(true) else 'off' }}
transform_null_equals = {{ 'on' if hx_pg_transform_null_equals | default(false) else 'off' }}

#------------------------------------------------------------------------------
# ERROR HANDLING
#------------------------------------------------------------------------------
exit_on_error = {{ 'on' if hx_pg_exit_on_error | default(false) else 'off' }}
restart_after_crash = {{ 'on' if hx_pg_restart_after_crash | default(true) else 'off' }}

#------------------------------------------------------------------------------
# CONFIG FILE INCLUDES
#------------------------------------------------------------------------------
{% if hx_pg_include_dir is defined %}
include_dir = '{{ hx_pg_include_dir }}'
{% endif %}
{% if hx_pg_include_if_exists is defined %}
include_if_exists = '{{ hx_pg_include_if_exists }}'
{% endif %}
{% if hx_pg_include is defined %}
include = '{{ hx_pg_include }}'
{% endif %}
