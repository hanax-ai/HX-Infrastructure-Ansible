
#!/bin/bash
# Health check script for {{ hx_webui_app_name }}
# Generated by Ansible - HX Web UI Install Standardized Role
# {{ ansible_managed }}

set -euo pipefail

# Configuration
APP_NAME="{{ hx_webui_app_name }}"
SERVER_NAME="{{ hx_webui_server_name }}"
HTTP_PORT="{{ hx_webui_listen_port }}"
{% if hx_webui_ssl_enabled %}
HTTPS_PORT="{{ hx_webui_ssl_port }}"
SSL_ENABLED=true
{% else %}
SSL_ENABLED=false
{% endif %}
HEALTH_ENDPOINT="{{ hx_webui_health_check_path | default('/health') }}"
LOG_FILE="/var/log/{{ hx_webui_server_type }}/health-check.log"

# Functions
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

check_http() {
    local url="http://${SERVER_NAME}:${HTTP_PORT}${HEALTH_ENDPOINT}"
    if curl -sf "$url" > /dev/null 2>&1; then
        log "HTTP health check: PASS"
        return 0
    else
        log "HTTP health check: FAIL"
        return 1
    fi
}

check_https() {
    if [ "$SSL_ENABLED" = "true" ]; then
        local url="https://${SERVER_NAME}:${HTTPS_PORT}${HEALTH_ENDPOINT}"
        if curl -sfk "$url" > /dev/null 2>&1; then
            log "HTTPS health check: PASS"
            return 0
        else
            log "HTTPS health check: FAIL"
            return 1
        fi
    else
        log "HTTPS health check: SKIPPED (SSL disabled)"
        return 0
    fi
}

check_service() {
    local service_name="{{ hx_webui_server_type }}"
    if systemctl is-active --quiet "$service_name"; then
        log "Service check ($service_name): PASS"
        return 0
    else
        log "Service check ($service_name): FAIL"
        return 1
    fi
}

check_disk_space() {
    local usage=$(df {{ hx_webui_root_dir }} | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "$usage" -lt 90 ]; then
        log "Disk space check: PASS (${usage}% used)"
        return 0
    else
        log "Disk space check: FAIL (${usage}% used)"
        return 1
    fi
}

# Main health check
main() {
    log "Starting health check for $APP_NAME"
    
    local exit_code=0
    
    check_service || exit_code=1
    check_http || exit_code=1
    check_https || exit_code=1
    check_disk_space || exit_code=1
    
    if [ $exit_code -eq 0 ]; then
        log "Health check completed: ALL CHECKS PASSED"
    else
        log "Health check completed: SOME CHECKS FAILED"
        # Optional: Send alert notification here
    fi
    
    return $exit_code
}

# Run health check
main "$@"
