# HX Web UI Nginx Configuration
# Generated by Ansible

upstream hx_webui_backend {
    server 127.0.0.1:{{ hx_webui_app_port }};
    keepalive 32;
}

server {
    listen {{ hx_webui_web_server_port }};
    server_name {{ ansible_fqdn }} {{ ansible_hostname }};
    
    {% if hx_webui_enable_ssl %}
    return 301 https://$server_name$request_uri;
}

server {
    listen {{ hx_webui_web_server_ssl_port }} ssl http2;
    server_name {{ ansible_fqdn }} {{ ansible_hostname }};
    
    # SSL Configuration
    ssl_certificate {{ hx_webui_ssl_cert_path }};
    ssl_certificate_key {{ hx_webui_ssl_key_path }};
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    {% endif %}
    
    # Security Headers
    {% for header, value in hx_webui_security_headers.items() %}
    add_header {{ header }} "{{ value }}" always;
    {% endfor %}
    
    # Rate Limiting
    {% if hx_webui_enable_rate_limiting %}
    limit_req_zone $binary_remote_addr zone=webui:10m rate={{ hx_webui_rate_limit }};
    limit_req zone=webui burst={{ hx_webui_rate_limit_burst }} nodelay;
    {% endif %}
    
    # Static Files
    location /static/ {
        alias {{ hx_webui_static_directory }}/;
        expires {{ hx_webui_cache_max_age }};
        add_header Cache-Control "public, immutable";
        {% if hx_webui_enable_gzip %}
        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        {% endif %}
    }
    
    # Health Check
    {% if hx_webui_enable_health_check %}
    location {{ hx_webui_health_check_path }} {
        proxy_pass http://hx_webui_backend{{ hx_webui_health_check_path }};
        access_log off;
    }
    {% endif %}
    
    # Metrics
    {% if hx_webui_enable_metrics %}
    location {{ hx_webui_metrics_path }} {
        proxy_pass http://hx_webui_backend{{ hx_webui_metrics_path }};
        allow 127.0.0.1;
        deny all;
    }
    {% endif %}
    
    # Main Application
    location / {
        proxy_pass http://hx_webui_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout {{ hx_webui_proxy_timeout | default(60) }}s;
    }
}
